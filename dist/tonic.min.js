class TonicRaw{constructor(rawText,templateStrings){this.isTonicRaw=!0,this.rawText=rawText,this.templateStrings=templateStrings}valueOf(){return this.rawText}toString(){return this.rawText}}class Tonic extends window.HTMLElement{constructor(){super();const state=Tonic._states[super.id];delete Tonic._states[super.id],this._state=state||{},this.preventRenderOnReconnect=!1,this.props={},this.elements=[...this.children],this.elements.__children__=!0,this.nodes=[...this.childNodes],this.nodes.__children__=!0,this._events()}static _createId(){return`tonic${Tonic._index++}`}static _splitName(s){return s.match(/[A-Z][a-z]*/g).join("-")}static _normalizeAttrs(o,x={}){return[...o].forEach(o=>x[o.name]=o.value),x}_checkId(){const _id=super.id;if(!_id){const html=this.outerHTML.replace(this.innerHTML,"...");throw new Error(`Component: ${html} has no id`)}return _id}get state(){return this._checkId(),this._state}set state(newState){this._state=(this._checkId(),newState)}get id(){return this._checkId()}set id(newId){super.id=newId}_events(){const hp=Object.getOwnPropertyNames(window.HTMLElement.prototype);for(const p of this._props)-1!==hp.indexOf("on"+p)&&this.addEventListener(p,this)}_prop(o){const id=this._id,p=`__${id}__${Tonic._createId()}__`;return Tonic._data[id]=Tonic._data[id]||{},Tonic._data[id][p]=o,p}_placehold(r){const id=this._id,ref=`placehold:${id}:${Tonic._createId()}__`;return Tonic._children[id]=Tonic._children[id]||{},Tonic._children[id][ref]=r,ref}static match(el,s){return el.matches||(el=el.parentElement),el.matches(s)?el:el.closest(s)}static getPropertyNames(proto){const props=[];while(proto&&proto!==Tonic.prototype)props.push(...Object.getOwnPropertyNames(proto)),proto=Object.getPrototypeOf(proto);return props}static add(c,htmlName){if(!(htmlName||c.name&&c.name.length>1))throw Error("Mangling. https://bit.ly/2TkJ6zP");if(htmlName||(htmlName=Tonic._splitName(c.name).toLowerCase()),!window.customElements.get(htmlName)){if(!c.prototype.isTonicComponent){const tmp={[c.name]:class extends Tonic{}}[c.name];tmp.prototype.render=c,c=tmp}c.prototype._props=Tonic.getPropertyNames(c.prototype),Tonic._reg[htmlName]=c,Tonic._tags=Object.keys(Tonic._reg).join(),window.customElements.define(htmlName,c),c.stylesheet&&Tonic.registerStyles(c.stylesheet)}}static registerStyles(stylesheetFn){if(Tonic._stylesheetRegistry.includes(stylesheetFn))return;Tonic._stylesheetRegistry.push(stylesheetFn);const styleNode=document.createElement("style");Tonic.nonce&&styleNode.setAttribute("nonce",Tonic.nonce),styleNode.appendChild(document.createTextNode(stylesheetFn())),document.head&&document.head.appendChild(styleNode)}static escape(s){return s.replace(Tonic.ESC,c=>Tonic.MAP[c])}static raw(s,templateStrings){return new TonicRaw(s,templateStrings)}html(strings,...values){const refs=o=>{if(o&&o.__children__)return this._placehold(o);if(o&&o.isTonicRaw)return o.rawText;switch(Object.prototype.toString.call(o)){case"[object HTMLCollection]":case"[object NodeList]":return this._placehold([...o]);case"[object Array]":case"[object Object]":case"[object Function]":return this._prop(o);case"[object NamedNodeMap]":return this._prop(Tonic._normalizeAttrs(o));case"[object Number]":return`${o}__float`;case"[object String]":return Tonic.escape(o);case"[object Boolean]":return`${o}__boolean`;case"[object Null]":return`${o}__null`;case"[object HTMLElement]":return this._placehold([o])}return"object"==typeof o&&o&&1===o.nodeType&&"function"==typeof o.cloneNode?this._placehold([o]):o},out=[];for(let i=0;i<strings.length-1;i++)out.push(strings[i],refs(values[i]));out.push(strings[strings.length-1]);const htmlStr=out.join("").replace(Tonic.SPREAD,(_,p)=>{const o=Tonic._data[p.split("__")[1]][p];return Object.entries(o).map(([key,value])=>{const k=key.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return!0===value?k:value?`${k}="${Tonic.escape(String(value))}"`:""}).filter(Boolean).join(" ")});return Tonic.raw(htmlStr,strings)}scheduleReRender(oldProps){return this.pendingReRender?this.pendingReRender:(this.pendingReRender=new Promise(resolve=>{window.setTimeout(()=>{const p=this._set(this.root,this.render);if(this.pendingReRender=null,p&&p.then)return p.then(()=>{this.updated&&this.updated(oldProps),resolve()});this.updated&&this.updated(oldProps),resolve()},0)}),this.pendingReRender)}reRender(o=this.props){const oldProps={...this.props};return this.props="function"==typeof o?o(oldProps):o,this.scheduleReRender(oldProps)}getProps(){return this.props}handleEvent(e){this[e.type](e)}_drainIterator(target,iterator){return iterator.next().then(result=>{if(this._set(target,null,result.value),!result.done)return this._drainIterator(target,iterator)})}_set(target,render,content=""){for(const node of target.querySelectorAll(Tonic._tags)){if(!node.isTonicComponent)continue;const id=node.getAttribute("id");id&&Tonic._refIds.includes(id)&&(Tonic._states[id]=node.state)}return render instanceof Tonic.AsyncFunction?render.call(this).then(content=>this._apply(target,content)):render instanceof Tonic.AsyncFunctionGenerator?this._drainIterator(target,render.call(this)):void(null===render?this._apply(target,content):render instanceof Function&&this._apply(target,render.call(this)||""))}_apply(target,content){if(content&&content.isTonicRaw&&(content=content.rawText),"string"==typeof content){if(this.stylesheet&&(content=`<style nonce=${Tonic.nonce||""}>${this.stylesheet()}</style>${content}`),target.innerHTML=content,this.styles){const styles=this.styles();for(const node of target.querySelectorAll("[styles]"))for(const s of node.getAttribute("styles").split(/\s+/))Object.assign(node.style,styles[s.trim()])}const children=Tonic._children[this._id]||{},walk=(node,fn)=>{if(3===node.nodeType){const id=node.textContent.trim();children[id]&&fn(node,children[id],id)}const childNodes=node.childNodes;if(childNodes)for(let i=0;i<childNodes.length;i++)walk(childNodes[i],fn)};walk(target,(node,children,id)=>{for(const child of children)node.parentNode.insertBefore(child,node);delete Tonic._children[this._id][id],node.parentNode.removeChild(node)})}else target.innerHTML="",target.appendChild(content.cloneNode(!0))}async connectedCallback(){this.root=this.shadowRoot||this,this.wrap&&(this.wrapped=this.render,this.render=this.wrap),super.id&&!Tonic._refIds.includes(super.id)&&Tonic._refIds.push(super.id);const cc=s=>s.replace(/-(.)/g,(_,m)=>m.toUpperCase());for(const{name:_name,value:value}of this.attributes){const name=cc(_name),p=this.props[name]=value;if(/__\w+__\w+__/.test(p)){const{1:root}=p.split("__");this.props[name]=Tonic._data[root][p]}else if(/\d+__float/.test(p))this.props[name]=parseFloat(p,10);else if("null__null"===p)this.props[name]=null;else if(/\w+__boolean/.test(p))this.props[name]=p.includes("true");else if(/placehold:\w+:\w+__/.test(p)){const{1:root}=p.split(":");this.props[name]=Tonic._children[root][p][0]}}if(this.props=Object.assign(this.defaults?this.defaults():{},this.props),this._id=this._id||Tonic._createId(),this.willConnect&&this.willConnect(),!this.preventRenderOnReconnect){this._source?this.innerHTML=this._source:this._source=this.innerHTML;const p=this._set(this.root,this.render);p&&p.then&&await p}this.connected&&this.connected()}disconnectedCallback(){this.disconnected&&this.disconnected(),delete Tonic._data[this._id],delete Tonic._children[this._id]}}Tonic.prototype.isTonicComponent=!0,Object.assign(Tonic,{_tags:"",_refIds:[],_data:{},_states:{},_children:{},_reg:{},_stylesheetRegistry:[],_index:0,version:"undefined"!=typeof require?require("./package").version:null,SPREAD:/\.\.\.\s?(__\w+__\w+__)/g,ESC:/["&'<>`]/g,AsyncFunctionGenerator:async function*(){}.constructor,AsyncFunction:async function(){}.constructor,MAP:{'"':"&quot;","&":"&amp;","'":"&#x27;","<":"&lt;",">":"&gt;","`":"&#x60;"}}),"object"==typeof module&&(module.exports=Tonic);